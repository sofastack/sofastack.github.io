<!DOCTYPE html>
<html>

<head>
	<title>
	动态部署 · SOFAStack
</title>
	<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="SOFAStack is a Scalable Open Financial Architecture for building cloud native applications" />

<meta name="generator" content="Hugo 0.55.5" /><link rel="shortcut icon" href=https://gw.alipayobjects.com/os/q/cms/images/jqu9346l/4ba95631-2489-4885-881f-bc7f8d787d5e_w64_h61.png type="image/png">

<link href="https://unpkg.com/purecss@1.0.0/build/base-min.css" rel="stylesheet">



<link href="/sofastack.tech/css/main.css" rel="stylesheet">
<link href="/sofastack.tech/css/zoom-image.css" rel="stylesheet">

<script src="/sofastack.tech/js/iconfont.js"></script>
<script src="/sofastack.tech/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script>window.SITE_LANGUAGE = "zh"</script>
<script src="/sofastack.tech/js/app.js"></script>





<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-142131411-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>

<body>
	<header class="ss-header">
	<nav class="navbar" role="navigation" aria-label="main navigation">
		<div class="navbar-brand">
			<a class="logo-link" href="/sofastack.tech/">
				<img class="logo" src="/sofastack.tech/img/logo.png">
			</a>
			<div class="-show-mobile">
				<a id="mobile-menu-icon">
					<svg class="icon" aria-hidden="true">
						<use xlink:href="#icon-menu"></use>
					</svg>
				</a>
				<nav id="mobile-menu">
						<div id="js-menu-search-mobile" class="navbar-search-mobile">
							<input class="input" placeholder="请输入要搜索的关键词">
							<svg class="icon" aria-hidden="true">
								<use xlink:href="#icon-search"></use>
							</svg>
						</div>
					
          
            <a
              class=""
              href="/sofastack.tech/projects/">
              <span>
                项目
              </span>
              <svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"></use></svg>
            </a>
					
            <a
              class=""
              href="/sofastack.tech/guides/">
              <span>
                指南
              </span>
              <svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"></use></svg>
            </a>
					
            <a
              class=""
              href="/sofastack.tech/blog/">
              <span>
                博客
              </span>
              <svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"></use></svg>
            </a>
					
            <a
              class=""
              href="/sofastack.tech/activities/">
              <span>
                活动
              </span>
              <svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"></use></svg>
            </a>
					
            <a
              class=""
              href="/sofastack.tech/community/">
              <span>
                社区
              </span>
              <svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"></use></svg>
            </a>
					
            <a
              class=""
              href="/sofastack.tech/awesome/">
              <span>
                Awesome SOFA
              </span>
              <svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"></use></svg>
            </a>
					
					
				</nav>
			</div>
		</div>

		<div class="navbar-menu -hidden-mobile">
			<div class="navbar-start">
				
				
					<a class="navbar-item "
						href="/sofastack.tech/projects/">项目</a>
				
					<a class="navbar-item "
						href="/sofastack.tech/guides/">指南</a>
				
					<a class="navbar-item "
						href="/sofastack.tech/blog/">博客</a>
				
					<a class="navbar-item "
						href="/sofastack.tech/activities/">活动</a>
				
					<a class="navbar-item "
						href="/sofastack.tech/community/">社区</a>
				
					<a class="navbar-item "
						href="/sofastack.tech/awesome/">Awesome SOFA</a>
				
			</div>
			<div class="navbar-end">
				<div class="navbar-item">
					<div id="js-menu-search" class="navbar-search">
						<input class="input" placeholder="请输入要搜索的关键词">
						<svg class="icon" aria-hidden="true">
							<use xlink:href="#icon-search"></use>
						</svg>
					</div>
				</div>
				<div class="navbar-item">
					
				</div>
			</div>
		</div>
	</nav>
</header>


	

	

	

	

	

	



	

<div class="ss-layout-container">
	<aside class="ss-layout-aside -left ss-card -soft-hidden">
		






	<div id="js-drawer" class="ss-toc">
		<div id="js-drawer-handle" class="drawer-handle">
			<svg class="icon icon-menu" aria-hidden="true">
				<use xlink:href="#icon-menu"></use>
			</svg>
			<svg class="icon icon-close" aria-hidden="true">
				<use xlink:href="#icon-close"></use>
			</svg>
		</div>
		<div class="drawer-body">
			<div class="header" title="SOFABoot 基于 Spring Boot 的研发框架，在其基础上提供了诸如 Readiness Check，类隔离，日志空间隔离，Bean 异步初始化等能力。">SOFABoot



























































































































































































































































































































































































































































































































































































<div class="ss-toc-list-card -hidden-mobile">
	<svg class="icon -hidden-mobile" aria-hidden="true">
		<use xlink:href="#icon-menu1"></use>
	</svg>
	<div class="ss-tooltip">
		
		
		<div class="toc-list">
			<h4 class="title">主要项目</h4>
			<ul class="list">
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-boot/overview/>
						SOFABoot
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-rpc/overview/>
						SOFARPC
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-tracer/overview/>
						SOFATracer
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-lookout/overview/>
						SOFALookout
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-registry/overview/>
						SOFARegistry
					</a>
				</li>
				
			</ul>
		</div>
		
		
		
		<div class="toc-list">
			<h4 class="title">孵化项目</h4>
			<ul class="list">
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-mesh/overview/>
						SOFAMesh
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-dashboard/overview/>
						SOFADashboard
					</a>
				</li>
				
			</ul>
		</div>
		
		
		
		<div class="toc-list">
			<h4 class="title">工具项目</h4>
			<ul class="list">
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-bolt/overview/>
						SOFABolt
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-jraft/overview/>
						SOFAJRaft
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					<a href=/sofastack.tech/projects/sofa-acts/overview/>
						SOFAActs
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					
					
					<a href=https://www.sofastack.tech/projects/sofa-boot/sofa-ark-readme//>
						SOFAArk
					</a>
				</li>
				
			</ul>
		</div>
		
		
		
		<div class="toc-list">
			<h4 class="title">生态项目</h4>
			<ul class="list">
				
				<li class="item">
					
					
					
					
					
					
					<a href=https://mosn.io/>
						MOSN
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					
					
					<a href=https://occlum.io/>
						Occlum
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					
					
					<a href=https://seata.io/>
						Seata
					</a>
				</li>
				
				<li class="item">
					
					
					
					
					
					
					<a href=https://mosn.io/layotto/>
						Layotto
					</a>
				</li>
				
			</ul>
		</div>
		
		
	</div>
</div>

			</div>
			<div class="body">
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot 介绍"
						href="/sofastack.tech/projects/sofa-boot/overview/"
					>SOFABoot 介绍</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="快速开始"
						href="/sofastack.tech/projects/sofa-boot/quick-start/"
					>快速开始</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="依赖管理"
						href="/sofastack.tech/projects/sofa-boot/dependency-management/"
					>依赖管理</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="健康检查"
						href="/sofastack.tech/projects/sofa-boot/health-check/"
					>健康检查</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="版本查看"
						href="/sofastack.tech/projects/sofa-boot/view-versions/"
					>版本查看</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="启动加速"
						href="/sofastack.tech/projects/sofa-boot/speed-up-startup/"
					>启动加速</a>
				</div>
			</li>
		
		
	
		
		
			<li class="item">
				<div class="link">
					<svg class="icon arrow" aria-hidden="true">
						<use xlink:href="#icon-arrow"></use>
					</svg>
					<a
						title="模块隔离"
					>模块隔离</a>
				</div>
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="模块化开发概述"
						href="/sofastack.tech/projects/sofa-boot/modular-development/"
					>模块化开发概述</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="模块配置"
						href="/sofastack.tech/projects/sofa-boot/sofaboot-module/"
					>模块配置</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="JVM 服务发布与引用"
						href="/sofastack.tech/projects/sofa-boot/module-service/"
					>JVM 服务发布与引用</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="模块并行化启动"
						href="/sofastack.tech/projects/sofa-boot/parallel-start/"
					>模块并行化启动</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Spring Bean 异步初始化"
						href="/sofastack.tech/projects/sofa-boot/bean-async-init/"
					>Spring Bean 异步初始化</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot Profile"
						href="/sofastack.tech/projects/sofa-boot/sofaboot-profile/"
					>SOFABoot Profile</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot 拓展点"
						href="/sofastack.tech/projects/sofa-boot/extension/"
					>SOFABoot 拓展点</a>
				</div>
			</li>
		
		
	
</ul>
			</li>
		
	
		
		
			<li class="item">
				<div class="link">
					<svg class="icon arrow" aria-hidden="true">
						<use xlink:href="#icon-arrow"></use>
					</svg>
					<a
						title="类隔离和热部署"
					>类隔离和热部署</a>
				</div>
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFAArk 介绍"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-readme/"
					>SOFAArk 介绍</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFAArk2.0 升级"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-migration-guide/"
					>SOFAArk2.0 升级</a>
				</div>
			</li>
		
		
	
		
		
			<li class="item">
				<div class="link">
					<svg class="icon arrow" aria-hidden="true">
						<use xlink:href="#icon-arrow"></use>
					</svg>
					<a
						title="快速开始"
					>快速开始</a>
				</div>
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="如何打包 Ark Plugin"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-plugin-demo/"
					>如何打包 Ark Plugin</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="如何打包 Ark 包"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-demo/"
					>如何打包 Ark 包</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Spring Boot 应用如何结合 SofaArk"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-spring-boot-demo/"
					>Spring Boot 应用如何结合 SofaArk</a>
				</div>
			</li>
		
		
	
</ul>
			</li>
		
	
		
		
			<li class="item">
				<div class="link">
					<svg class="icon arrow" aria-hidden="true">
						<use xlink:href="#icon-arrow"></use>
					</svg>
					<a
						title="用户文档"
					>用户文档</a>
				</div>
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="基础术语"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-terminology/"
					>基础术语</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 包"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-jar/"
					>Ark 包</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark Plugin"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-plugin/"
					>Ark Plugin</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark Biz"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-biz/"
					>Ark Biz</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFAArk 配置"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-config/"
					>SOFAArk 配置</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark Biz 生命周期"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-biz-lifecycle/"
					>Ark Biz 生命周期</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Zookeeper 配置"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-zk-config/"
					>Zookeeper 配置</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 服务机制"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-service/"
					>Ark 服务机制</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 事件机制"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-event/"
					>Ark 事件机制</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 扩展机制"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-extension/"
					>Ark 扩展机制</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 服务通信"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-jvm/"
					>Ark 服务通信</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Telnet 指令"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-telnet/"
					>Telnet 指令</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 日志"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-ark-log/"
					>Ark 日志</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot 使用类隔离"
						href="/sofastack.tech/projects/sofa-boot/classloader-isolation/"
					>SOFABoot 使用类隔离</a>
				</div>
			</li>
		
		
	
</ul>
			</li>
		
	
		
		
			<li class="item">
				<div class="link">
					<svg class="icon arrow" aria-hidden="true">
						<use xlink:href="#icon-arrow"></use>
					</svg>
					<a
						title="开发文档"
					>开发文档</a>
				</div>
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 容器启动流程"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-startup/"
					>Ark 容器启动流程</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 容器插件机制"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-plugin/"
					>Ark 容器插件机制</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Ark 容器类加载机制"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-classloader/"
					>Ark 容器类加载机制</a>
				</div>
			</li>
		
		
	
</ul>
			</li>
		
	
		
		
			<li class="item">
				<div class="link">
					<svg class="icon arrow" aria-hidden="true">
						<use xlink:href="#icon-arrow"></use>
					</svg>
					<a
						title="源码解析"
					>源码解析</a>
				</div>
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="打包插件"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-build-package-plugin/"
					>打包插件</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="启动过程"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-startup-process/"
					>启动过程</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link -current">
					<a
						title="动态部署"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-dynamic-deploy/"
					>动态部署</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="类委托加载"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-class-loader-delegation/"
					>类委托加载</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="多 Web 模块部署"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-multi-web-component-deploy/"
					>多 Web 模块部署</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="Benchmark"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-benchmark/"
					>Benchmark</a>
				</div>
			</li>
		
		
	
</ul>
			</li>
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="发布说明"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-release/"
					>发布说明</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="发展路线"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-roadmap/"
					>发展路线</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="公开分享"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-public-presentation/"
					>公开分享</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="如何贡献"
						href="/sofastack.tech/projects/sofa-boot/sofa-ark-contribution/"
					>如何贡献</a>
				</div>
			</li>
		
		
	
</ul>
			</li>
		
	
		
		
			<li class="item">
				<div class="link">
					<svg class="icon arrow" aria-hidden="true">
						<use xlink:href="#icon-arrow"></use>
					</svg>
					<a
						title="源码解析"
					>源码解析</a>
				</div>
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot HealthCheck 机制解析"
						href="/sofastack.tech/projects/sofa-boot/sofaboot-healthcheck-mechanism-explained/"
					>SOFABoot HealthCheck 机制解析</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot 组件协议 binding 机制解析"
						href="/sofastack.tech/projects/sofa-boot/sofaboot-component-protocol-binding/"
					>SOFABoot 组件协议 binding 机制解析</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot 上下文隔离机制解析"
						href="/sofastack.tech/projects/sofa-boot/sofa-boot-context-isolation-mechanism-explained/"
					>SOFABoot 上下文隔离机制解析</a>
				</div>
			</li>
		
		
	
</ul>
			</li>
		
	
		
		
			<li class="item">
				<div class="link">
					<svg class="icon arrow" aria-hidden="true">
						<use xlink:href="#icon-arrow"></use>
					</svg>
					<a
						title="升级文档"
					>升级文档</a>
				</div>
				



<ul class="leaf-section">
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot 2.5.x 升级注意事项"
						href="/sofastack.tech/projects/sofa-boot/upgrade_2_5_x/"
					>SOFABoot 2.5.x 升级注意事项</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot 3.0 升级注意事项"
						href="/sofastack.tech/projects/sofa-boot/upgrade_3_x/"
					>SOFABoot 3.0 升级注意事项</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="SOFABoot 4.0 升级注意事项"
						href="/sofastack.tech/projects/sofa-boot/upgrade_4_x/"
					>SOFABoot 4.0 升级注意事项</a>
				</div>
			</li>
		
		
	
</ul>
			</li>
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="常见问题"
						href="/sofastack.tech/projects/sofa-boot/faq/"
					>常见问题</a>
				</div>
			</li>
		
		
	
		
			<li class="item">
				<div class="link">
					<a
						title="版权声明"
						href="/sofastack.tech/projects/sofa-boot/notice/"
					>版权声明</a>
				</div>
			</li>
		
		
	
</ul>
			</div>
		</div>
	</div>

	</aside>

	<main class="ss-layout-main -card">
		




<div class="ss-meta">
	<div class="container">
		<h1 class="title">
			动态部署
		</h1>
		<a class="edit-button -hidden-mobile"
			href="https://github.com/sofastack/sofastack.tech/edit/master/content/zh/projects/sofa-boot/sofa-ark-dynamic-deploy/index.md"
		>编辑</a>
	</div>
	<div class="meta">
		更新时间: 2024-06-18 
		
			
			·   
					<a href="https://github.com/it-linnan">林楠</a> 
				
			
		
	</div>
</div>

		<article class="typo">
  <h2 id="前言">前言</h2>

<p>在实践中，我们通常会使用业务功能模块化的开发模式，部署时将不同模块合并部署，由于团队间技术栈不统一，此时就有可能出现依赖冲突等问题。SOFAArk 定义了一种开发规范，将不同的应用模块打包成 Ark Biz，由一个基座 Biz 和多个 Biz 模块组成部署包，支持两种合并部署的方式，一种是静态合并部署，Ark Biz 以 Maven 依赖的方式引入项目；另一种是在运行时使用 API 或者 配置中心（Zookeeper）动态地安装或卸载 Biz，本文将重点讨论此方式。</p>

<h2 id="ark-biz-的生命周期">Ark Biz 的生命周期</h2>

<p><img src="lifecycle.png" alt="生命周期" /></p>

<p>Ark Biz 的生命周期主要包含三条指令：</p>

<ul>
<li>install: 安装 Biz</li>
<li>uninstall: 卸载 Biz</li>
<li>switch: 激活 Biz</li>
</ul>

<p>在动态的安装和卸载时，Ark Biz 会流转于生命周期的五个阶段，Biz 在不同阶段时的状态如下：</p>

<ul>
<li>unresolved: 未注册，此时 Biz 包未被运行时解析</li>
<li>resolved: Biz 包解析完成，且已注册，此时 Biz 包还没有安装或者安装中</li>
<li>activated: Biz 包启动完成，且处于激活状态，可以对外提供服务</li>
<li>broken: Biz 包启动失败后状态</li>
<li>deactivated: Biz 包启动完成，但处于未激活状态(注意这个状态只对 JVM 服务生效，对 RPC 等其他中间件无效)</li>
</ul>

<p>这里我们可以看一下 Ark Biz
的数据模型 BizModel 类：</p>

<pre><code class="language-java">public class BizModel implements Biz {
    ...
    private String   bizName;
    private String   bizVersion;
    private BizState bizState;
    ...
}
</code></pre>

<p>在 Ark Biz 的数据模型中 bizState 表示的就是当前状态，可以看到数据模型中定义了 Biz 包的名称和版本号，在运行时 SOFAArk 允许部署相同名称不同版本的 Biz，但只能有一个版本处于 activated 激活状态，其他版本的 Biz 状态将自动处于 deactivated 未激活状态。</p>

<h2 id="install">install</h2>

<p><img src="install.png" alt="intall" /></p>

<p>在入口方法 ArkClient#installOperation 中，下载 Biz 包到本地临时文件，临时文件命名规则：${bizName}-${bizVersion}-${时间戳}。准备好 Biz 包后，调用 installBiz 方法，进入安装主流程。</p>

<pre><code class="language-java">public static ClientResponse installOperation(BizOperation bizOperation) throws Throwable {
    return installOperation(bizOperation, arguments);
}
public static ClientResponse installOperation(BizOperation bizOperation, String[] args) throws Throwable {
    ...
    if (bizOperation.getParameters().get(Constants.CONFIG_BIZ_URL) != null) {
        URL url = new URL(bizOperation.getParameters().get(Constants.CONFIG_BIZ_URL));
        bizFile = ArkClient.createBizSaveFile(bizOperation.getBizName(), bizOperation.getBizVersion());
        FileUtils.copyInputStreamToFile(url.openStream(), bizFile);
    }
    return installBiz(bizFile, args);
}
</code></pre>

<p>安装 Ark Biz 的主流程：</p>

<ol>
<li>解析 Biz 包，创建 BizModel</li>
<li>将 Ark Biz 注册到 Biz Manager 中（如果已经注册过，安装流程将直接结束，并返回提示信息）</li>
<li>启动 Ark Biz</li>
<li>如果启动失败，则关停并卸载 Ark Biz</li>
</ol>

<pre><code class="language-java">public static ClientResponse installBiz(File bizFile, String[] args) throws Throwable {
    ...
    Biz biz = bizFactoryService.createBiz(bizFile); // 1
    ClientResponse response = new ClientResponse();
    if (bizManagerService.getBizByIdentity(biz.getIdentity()) != null
        || !bizManagerService.registerBiz(biz)) { // 2
        return response.setCode(ResponseCode.REPEAT_BIZ).setMessage(
            String.format(&quot;Biz: %s has been installed or registered.&quot;, biz.getIdentity()));
    }

    try {
        biz.start(args); // 3
        ...
        response
            .setCode(ResponseCode.SUCCESS)
            .setMessage(
                String.format(&quot;Install Biz: %s success, cost: %s ms, started at: %s&quot;,
                    biz.getIdentity(), end - start, startDate))
            .setBizInfos(Collections.&lt;BizInfo&gt; singleton(biz));
        return response;
    } catch (Throwable throwable) {
        ...
        response.setCode(ResponseCode.FAILED).setMessage(
            String.format(&quot;Install Biz: %s fail,cost: %s ms, started at: %s&quot;,
                biz.getIdentity(), end - start, startDate));
        ...
        try {
            biz.stop(); // 4
        } catch (Throwable e) {
            ...
            throw e;
        } finally {
            bizManagerService.unRegisterBizStrictly(biz.getBizName(), biz.getBizVersion());
        }
        return response;
    }
}
</code></pre>

<h3 id="解析-ark-biz">解析 Ark Biz</h3>

<p>当开启内嵌模式时，将 Biz 包解压到 ${Biz}-unpack 目录下，生成展开型的 Biz 包；当未开启内嵌模式时，直接使用原始的 Biz Jar 包，生成压缩型的 Biz 包。
这里生成 Biz 包是为了后续做类隔离做准备，在使用 ClassLoader.loadClass 方法查找类时，需要到不同的目标文件夹内查找。</p>

<pre><code class="language-java">public Biz createBiz(File file) throws IOException {
    BizArchive bizArchive;
    if (ArkConfigs.isEmbedEnable()) {
        File unpackFile = new File(file.getAbsolutePath() + &quot;-unpack&quot;);
        if (!unpackFile.exists()) {
            unpackFile = FileUtils.unzip(file, file.getAbsolutePath() + &quot;-unpack&quot;);
        }
        if (file.exists()) {
            file.delete();
        }
        file = unpackFile;
        bizArchive = new ExplodedBizArchive(unpackFile);
    } else {
        JarFile bizFile = new JarFile(file);
        JarFileArchive jarFileArchive = new JarFileArchive(bizFile);
        bizArchive = new JarBizArchive(jarFileArchive);
    }
    BizModel biz = (BizModel) createBiz(bizArchive);
    biz.setBizTempWorkDir(file);
    return biz;
}
</code></pre>

<ol>
<li>从 Manifest 清单文件中解析基本信息（如MainClass），根据基本信息创建 BizModel，将 Ark Biz 的状态设置为 resolved</li>
<li>创建 ClassLoader 设置到 BizModel 中</li>
</ol>

<pre><code class="language-java">public Biz createBiz(BizArchive bizArchive) throws IOException {
    ...
    // 1
    Attributes manifestMainAttributes = bizArchive.getManifest().getMainAttributes();
    bizModel
        .setBizState(BizState.RESOLVED)
        .setBizName(manifestMainAttributes.getValue(ARK_BIZ_NAME))
        .setBizVersion(manifestMainAttributes.getValue(ARK_BIZ_VERSION))
        .setMainClass(manifestMainAttributes.getValue(MAIN_CLASS_ATTRIBUTE))
        ...
        .setClassPath(bizArchive.getUrls());
    // 2
    BizClassLoader bizClassLoader = new BizClassLoader(bizModel.getIdentity(),
        getBizUcp(bizModel.getClassPath()), bizArchive instanceof ExplodedBizArchive
                                            || bizArchive instanceof DirectoryBizArchive);
    bizClassLoader.setBizModel(bizModel);
    bizModel.setClassLoader(bizClassLoader);
    bizClassLoader.setBizModel(bizModel);
    return bizModel;
}
</code></pre>

<h3 id="启动-ark-biz">启动 Ark Biz</h3>

<ol>
<li>将当前线程上下文 ClassLoader 设置为 BizModel 的 ClassLoader，并暂存原 ClassLoader</li>
<li>基于 BizModel ClassLoader 反射查找 MainClass，调用 main 方法</li>
<li>发布 AfterBizStartupEvent 事件，可以看到源码中的注释表示这里会触发健康检查，我们先记下这个点稍后解答</li>
<li>如果启动失败，就将 Ark Biz 状态设置为 broken</li>
<li>将 ClassLoader 恢复回去</li>
<li>当前配置的模式是默认激活新模块，将 Ark Biz 状态设置为 activated。检查当前是否有同名 Biz 处于 activated 状态，如果有就将旧的 Biz 状态设置为 deactivated</li>
<li>当前配置的模式不是默认激活新模块，先检查当前是否有同名 Biz 处于 activated 状态，如果没有，就将本次安装的 Ark Biz 激活；如果有，则将本次安装的 Ark Biz 状态设置为 deactivated</li>
</ol>

<pre><code class="language-java">public void start(String[] args) throws Throwable {
    ...
    ClassLoader oldClassLoader = ClassLoaderUtils.pushContextClassLoader(this.classLoader); // 1
    EventAdminService eventAdminService = ArkServiceContainerHolder.getContainer().getService(EventAdminService.class);
    try {
        eventAdminService.sendEvent(new BeforeBizStartupEvent(this));
        resetProperties();
        if (!isMasterBizAndEmbedEnable()) {
            ...
            // 2
            MainMethodRunner mainMethodRunner = new MainMethodRunner(mainClass, args);
            mainMethodRunner.run();
            // this can trigger health checker handler
            eventAdminService.sendEvent(new AfterBizStartupEvent(this)); // 3
            ...
        }
    } catch (Throwable e) {
        bizState = BizState.BROKEN; // 4
        throw e;
    } finally {
        ClassLoaderUtils.popContextClassLoader(oldClassLoader); // 5
    }
    BizManagerService bizManagerService = ArkServiceContainerHolder.getContainer().getService(BizManagerService.class);
    // 6
    if (Boolean.getBoolean(Constants.ACTIVATE_NEW_MODULE)) {
        Biz currentActiveBiz = bizManagerService.getActiveBiz(bizName);
        if (currentActiveBiz == null) {
            bizState = BizState.ACTIVATED;
        } else {
            ((BizModel) currentActiveBiz).setBizState(BizState.DEACTIVATED);
            bizState = BizState.ACTIVATED;
        }
    } else {
        // 7
        if (bizManagerService.getActiveBiz(bizName) == null) {
            bizState = BizState.ACTIVATED;
        } else {
            bizState = BizState.DEACTIVATED;
        }
    }
}
</code></pre>

<h3 id="关停-ark-biz">关停 Ark Biz</h3>

<ol>
<li>将当前线程上下文 ClassLoader 设置为 BizModel 的 ClassLoader，并暂存原 ClassLoader</li>
<li>将 Ark Biz 状态设置为 deactivated</li>
<li>发布 BeforeBizStopEvent 事件，可以看到源码中的注释表示这里会触发 uninstall 卸载操作，我们先记下这个点稍后解答</li>
<li>从  Biz Manager 移除本次安装的 Ark Biz</li>
<li>将 Ark Biz 状态恢复到初始状态 unresolved</li>
<li>将 ClassLoader 恢复回去</li>
</ol>

<pre><code class="language-java">public void stop() {
    ...
    ClassLoader oldClassLoader = ClassLoaderUtils.pushContextClassLoader(this.classLoader); // 1
    bizState = BizState.DEACTIVATED; // 2
    EventAdminService eventAdminService = ArkServiceContainerHolder.getContainer().getService(EventAdminService.class);
    try {
        // this can trigger uninstall handler
        eventAdminService.sendEvent(new BeforeBizStopEvent(this)); // 3
    } finally {
        BizManagerService bizManagerService = ArkServiceContainerHolder.getContainer().getService(BizManagerService.class);
        bizManagerService.unRegisterBiz(bizName, bizVersion); // 4
        bizState = BizState.UNRESOLVED; // 5
        eventAdminService.sendEvent(new BeforeBizRecycleEvent(this));
        ...// 省略了一部分清理缓存的代码
        ClassLoaderUtils.popContextClassLoader(oldClassLoader); // 6
        eventAdminService.sendEvent(new AfterBizStopEvent(this));
    }
}
</code></pre>

<h3 id="事件发布机制">事件发布机制</h3>

<p>上文中介绍了 install 的源码，在动态安装 Ark Biz 的流程中，我们遗留了两个关于事件发布的问题。</p>

<p>第一处是当 Ark Biz 启动成功后，发布 AfterBizStartupEvent 事件，触发健康检查：</p>

<pre><code class="language-java">public void start(String[] args) throws Throwable {
    ...
    MainMethodRunner mainMethodRunner = new MainMethodRunner(mainClass, args);
    mainMethodRunner.run();
    // this can trigger health checker handler
    eventAdminService.sendEvent(new AfterBizStartupEvent(this));
    ...
}
</code></pre>

<p>这里需要结合 SOFABoot 理解，在 SOFABoot 源码中有一个 SofaBizHealthCheckEventHandler 类，是 AfterBizStartupEvent 事件的监听器：</p>

<pre><code class="language-java">public class SofaBizHealthCheckEventHandler implements EventHandler&lt;AfterBizStartupEvent&gt; {
    @Override
    public void handleEvent(AfterBizStartupEvent event) {
        doHealthCheck(event.getSource());
    }
    private void doHealthCheck(Biz biz) {
        SofaRuntimeManager sofaRuntimeManager = getSofaRuntimeManager(biz);
        if (!sofaRuntimeManager.isReadinessHealth()) {
            throw new RuntimeException(&quot;Health check failed.&quot;);
        }
    }
    ...
}
</code></pre>

<p>SofaBizHealthCheckEventHandler 监听 AfterBizStartupEvent 事件，当事件发布时，就会调用 doHealthCheck 方法，从而实现在 Ark Biz 启动后，自动进行健康检查。当健康检查未通过时，会抛出异常，将进入 Ark Biz 启动失败的流程。</p>

<p>第二处是当 Ark Biz 启动失败，关停 Ark Biz 时，发布 BeforeBizStopEvent 事件，触发 uninstall 卸载操作：</p>

<pre><code class="language-java">public void stop() {
    ...
    // this can trigger uninstall handler
    eventAdminService.sendEvent(new BeforeBizStopEvent(this)); // 3
    ...
}
</code></pre>

<p>这里同样需要结合 SOFABoot 理解，在 SOFABoot 源码中有一个 SofaBizUninstallEventHandler 类，是 BeforeBizStopEvent 事件的监听器：</p>

<pre><code class="language-java">public class SofaBizUninstallEventHandler implements EventHandler&lt;BeforeBizStopEvent&gt; {
    @Override
    public void handleEvent(BeforeBizStopEvent event) {
        doUninstallBiz(event.getSource());
    }
    private void doUninstallBiz(Biz biz) {
        // Remove dynamic JVM service cache
        DynamicJvmServiceProxyFinder.getDynamicJvmServiceProxyFinder().afterBizUninstall(biz);
        SofaRuntimeProperties.unRegisterProperties(biz.getBizClassLoader());
        SofaRuntimeManager sofaRuntimeManager = getSofaRuntimeManager(biz);
        SofaFramework.unRegisterSofaRuntimeManager(sofaRuntimeManager);
        sofaRuntimeManager.shutDownExternally();
    }
    ...
}
</code></pre>

<p>SofaBizUninstallEventHandler 监听 BeforeBizStopEvent 事件，当事件发布时，调用 doUninstallBiz 方法，清理 JVM 服务、上下文参数等缓存，并在 SofaRuntimeManager#shutDownExternally 方法中关闭基座 Biz 的 Spring 上下文。</p>

<h2 id="uninstall">uninstall</h2>

<p>入口方法 ArkClient#uninstallOperation 中调用 uninstallBiz 方法，进入卸载流程。</p>

<pre><code class="language-java">public static ClientResponse uninstallOperation(BizOperation bizOperation) throws Throwable {
    ...
    return uninstallBiz(bizOperation.getBizName(), bizOperation.getBizVersion());
}
</code></pre>

<p>卸载 Ark Biz 的主流程：</p>

<ol>
<li>判断要卸载的 Ark Biz 是否是基座，基座是主进程，不允许卸载</li>
<li>在 Biz Manager 中查找 Ark Biz</li>
<li>未查找到要卸载的 Ark Biz 时，返回 NOTFOUND 提示信息</li>
<li><a href="#关停-ark-biz">关停 Ark Biz</a></li>
<li>从 Biz Manager 中移除 Ark Biz</li>
<li>卸载成功，返回成功提示</li>
</ol>

<pre><code class="language-java">public static ClientResponse uninstallBiz(String bizName, String bizVersion) throws Throwable {
    ...
    // 1
    if (bizName.equals(ArkConfigs.getStringValue(Constants.MASTER_BIZ))) {
        return new ClientResponse().setCode(ResponseCode.FAILED).setMessage(&quot;Master biz must not be uninstalled.&quot;);
    }
    Biz biz = bizManagerService.getBiz(bizName, bizVersion); // 2
    ClientResponse response = new ClientResponse().setCode(ResponseCode.NOT_FOUND_BIZ) // 3
        .setMessage(
            String.format(&quot;Uninstall biz: %s not found.&quot;,
                BizIdentityUtils.generateBizIdentity(bizName, bizVersion)));
    if (biz != null) {
        try {
            biz.stop(); // 4
        } catch (Throwable throwable) {
            ...
            throw throwable;
        } finally {
            bizManagerService.unRegisterBizStrictly(biz.getBizName(), biz.getBizVersion()); // 5
        }
        // 6
        response.setCode(ResponseCode.SUCCESS).setMessage(String.format(&quot;Uninstall biz: %s success.&quot;, biz.getIdentity()));
    }
    return response;
}
</code></pre>

<h2 id="switch">switch</h2>

<p>入口方法 ArkClient#switchOperation 中调用 switchBiz 方法，进入激活 Biz 流程。</p>

<pre><code class="language-java">public static ClientResponse switchOperation(BizOperation bizOperation) {
    ...
    return switchBiz(bizOperation.getBizName(), bizOperation.getBizVersion());
}
</code></pre>

<p>激活 Ark Biz 的主流程：</p>

<ol>
<li>在 Biz Manager 中查找 Ark Biz</li>
<li>未查找到 Ark Biz 时，返回 NOTFOUND 提示信息</li>
<li>当要激活的 Ark Biz 状态不是 activated 或 deactivated，Ark Biz 没有成功安装过，不能直接激活，此时返回 ILLEGAL_STATE 提示信息</li>
<li>激活 Ark Biz</li>
</ol>

<pre><code class="language-java">public static ClientResponse switchBiz(String bizName, String bizVersion) {
    ...
    Biz biz = bizManagerService.getBiz(bizName, bizVersion); // 1
    ClientResponse response = new ClientResponse().setCode(ResponseCode.NOT_FOUND_BIZ) // 2
        .setMessage(
            String.format(&quot;Switch biz: %s not found.&quot;,
                BizIdentityUtils.generateBizIdentity(bizName, bizVersion)));
    if (biz != null) {
        if (biz.getBizState() != BizState.ACTIVATED
            &amp;&amp; biz.getBizState() != BizState.DEACTIVATED) {
            // 3
            response.setCode(ResponseCode.ILLEGAL_STATE_BIZ).setMessage(
                String.format(&quot;Switch Biz: %s's state must not be %s.&quot;, biz.getIdentity(),
                    biz.getBizState()));
        } else {
            eventAdminService.sendEvent(new BeforeBizSwitchEvent(biz));
            bizManagerService.activeBiz(bizName, bizVersion); // 4
            eventAdminService.sendEvent(new AfterBizSwitchEvent(biz));
            response.setCode(ResponseCode.SUCCESS).setMessage(
                String.format(&quot;Switch biz: %s is activated.&quot;, biz.getIdentity()));
        }
    }
    ...
    return response;
}
</code></pre>

<p>激活 Ark Biz 时，需要先查找当前是否有同名 Biz 处于激活状态，如果有需要将状态切换为 deactivated，再将本次要激活的 Ark Biz 状态设置为 activated。</p>

<pre><code class="language-java">public void activeBiz(String bizName, String bizVersion) {
    ...
    Biz biz = getBiz(bizName, bizVersion);
    Biz activeBiz = getActiveBiz(bizName);
    if (biz != null &amp;&amp; biz.getBizState() == BizState.DEACTIVATED) {
        if (activeBiz != null) {
            ((BizModel) activeBiz).setBizState(BizState.DEACTIVATED);
        }
        ((BizModel) biz).setBizState(BizState.ACTIVATED);
    }
}
</code></pre>

<h2 id="telnet-指令">Telnet 指令</h2>

<p>SOFAArk 提供了 telnet 小工具，用于运行时查看容器状态、执行动态部署指令等，接下来介绍下 telnet 小工具是如何实现动态部署的。</p>

<p>NettyTelnetHandler 作为 telnet 的入口，监听用户输入信息，委托 ArkCommandHandler 处理，并返回结果输出到控制台中。</p>

<pre><code class="language-java">static class NettyTelnetHandler extends SimpleChannelInboundHandler&lt;String&gt; {
    private static ArkCommandHandler arkCommandHandler = new ArkCommandHandler();
    ...
    @Override
    protected void channelRead0(ChannelHandlerContext ctx, String msg) throws Exception {
        ...
        ctx.write(arkCommandHandler.responseMessage(msg));
        ...
    }
}
</code></pre>

<p>ArkCommandHandler 中委托 CommandProvider 解析用户输入的命令：</p>

<pre><code class="language-java">public String responseMessage(String cmd) {
    String commandResult = handleCommand(cmd);
    ...
    return commandResult;
}
public String handleCommand(String cmdLine) {
    ...
    for (ServiceReference&lt;CommandProvider&gt; commandService : commandProviders) {
        CommandProvider commandProvider = commandService.getService();
        if (commandProvider.validate(cmdLine)) {
            return commandProvider.handleCommand(cmdLine);
        }
    }
    return helpMessage(commandProviders);
}
</code></pre>

<p>在 BizCommandProvider 中委托 BizCommand 处理用户输入的命令：</p>

<pre><code class="language-java">public String handleCommand(String command) {
    return new BizCommand(command).process();
}
</code></pre>

<p>在 BizCommand 中，根据用户输入命令调用相应的编程 API，以安装 Ark Biz 为例：</p>

<ol>
<li>用户输入命令为 i 时，调用 installBiz 方法，进入安装流程</li>
<li>将用户输入的参数部分组装成 BizOperation</li>
<li>调用 ArkClient.installOperation 进入<a href="#install">安装主流程</a></li>
</ol>

<pre><code class="language-java">String process() {
    ...
    if (options.contains('h')) {
        return HELP_MESSAGE;
    } else if (options.contains('a')) {
        return bizList();
    } else if (options.contains('i')) {
        return installBiz();// 1
    } else if (options.contains('u')) {
        return uninstallBiz();
    } else if (options.contains('o')) {
        return switchBiz();
    } else {
        ...
    }
    return sb.toString();
}
 String installBiz() {
    ...
    BizOperation bizOperation = new BizOperation().setOperationType(BizOperation.OperationType.INSTALL);
    String param = parameters.toArray(new String[] {})[0];
    try {
        // 2
        URL url = new URL(param);
        bizOperation.putParameter(Constants.CONFIG_BIZ_URL, param);
    } catch (Throwable t) {
        String[] nameAndVersion = param.split(Constants.STRING_COLON);
        if (nameAndVersion.length != 2) {
            LOGGER.error(&quot;Invalid telnet biz install command {}&quot;, param);
            return;
        }
        bizOperation.setBizName(nameAndVersion[0]).setBizVersion(nameAndVersion[1]);
    }
    try {
        ArkClient.installOperation(bizOperation); // 3
    } catch (Throwable throwable) {
        LOGGER.error(&quot;Fail to process telnet install command: &quot; + param, throwable);
    }
    ...
}
</code></pre>

<blockquote>
<p>telnet 服务端只是 SOFAArk 提供的方便运行时查看信息工具，不推荐直接通过 telnet 指令在线上执行 Biz 操作指令，推荐使用 API 或者动态配置方式。</p>
</blockquote>

<h2 id="zookeeper-动态配置">Zookeeper 动态配置</h2>

<p>SOFAArk 提供的动态配置插件，通过 Zookeeper 下发动态部署指令</p>

<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;config-ark-plugin&lt;/artifactId&gt;
    &lt;version&gt;${sofa.ark.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>在 ConfigProcessor 入口类中，注册定时任务，长轮询拉取配置数据：</p>

<pre><code class="language-java">public void start() {
    commonThreadPool.getExecutor().execute(new ConfigTask());
}

class ConfigTask implements Runnable {
    @Override
    public void run() {
        while (true) {
            ...
            String config = configDeque.poll();
            if (config == null) {
                sleep(200);
                continue;
            }
            ...
            OperationProcessor.process(OperationTransformer.transformToBizOperation(config, pluginContext));
            ...
        }
    }
}
</code></pre>

<p>调用 OperationTransformer#transformToBizOperation 方法将配置数据转换为 BizOperation，此处的源码不做详细说明，感兴趣的同学可以结合<a href="https://www.sofastack.tech/projects/sofa-boot/sofa-ark-zk-config/">Zookeeper 配置</a>阅读源码</p>

<p>在 OperationProcessor#process 方法中，根据指令类型，调用 ArkClient 的不同方法：</p>

<pre><code class="language-java">public static List&lt;ClientResponse&gt; process(List&lt;BizOperation&gt; bizOperations) {
    List&lt;ClientResponse&gt; clientResponses = new ArrayList&lt;&gt;();
    try {
        for (BizOperation bizOperation : bizOperations) {
            ...
            switch (bizOperation.getOperationType()) {
                case INSTALL:
                    clientResponses.add(ArkClient.installOperation(bizOperation));
                    break;
                case UNINSTALL:
                    clientResponses.add(ArkClient.uninstallOperation(bizOperation));
                    break;
                case SWITCH:
                    clientResponses.add(ArkClient.switchOperation(bizOperation));
                    break;
                case CHECK:
                    clientResponses.add(ArkClient.checkOperation(bizOperation));
                    break;
                ...
            }
        }
    } catch (Throwable throwable) {
        throw new ArkRuntimeException(&quot;Failed to execute biz operations.&quot;, throwable);
    }
    return clientResponses;
}
</code></pre>

<h3 id="check">check</h3>

<p>Zookeeper 动态下发指令支持 check指令，check 指令用于查询 Ark Biz 安装情况。</p>

<p>入口方法 ArkClient#checkOperation 中调用 checkBiz 方法，进入查询 Biz 流程。</p>

<pre><code class="language-java">public static ClientResponse checkOperation(BizOperation bizOperation) {
    ...
    return checkBiz(bizOperation.getBizName(), bizOperation.getBizVersion());
}
</code></pre>

<p>查询 Ark Biz 的主流程：</p>

<ol>
<li>在 Biz Manager 中查找 Ark Biz

<ol>
<li>当 Ark Biz 名称和版本都传入的情况，在 Biz Manager 中查找指定名称和版本的 Ark Biz</li>
<li>当传入 Ark Biz 名称的情况，在 Biz Manager 中查找该名称所有版本的 Ark Biz</li>
<li>当没有传入参数的情况，将在 Biz Manager 中注册的所有 Ark Biz 都查找出来</li>
</ol></li>
<li>将符合条件的 Ark Biz 组装并返回</li>
</ol>

<pre><code class="language-java">public static ClientResponse checkBiz(String bizName, String bizVersion) {
    ...
    ClientResponse response = new ClientResponse();
    Set&lt;BizInfo&gt; bizInfoSet = new HashSet&lt;&gt;();
    if (bizName != null &amp;&amp; bizVersion != null) {
        // 1.1
        Biz biz = bizManagerService.getBiz(bizName, bizVersion);
        if (biz != null) {
            bizInfoSet.add(biz);
        }
    } else if (bizName != null) {
        // 1.2
        bizInfoSet.addAll(bizManagerService.getBiz(bizName));
    } else {
        // 1.3
        bizInfoSet.addAll(bizManagerService.getBizInOrder());
    }
    // 2
    StringBuilder sb = new StringBuilder();
    sb.append(String.format(&quot;Biz count=%d&quot;, bizInfoSet.size())).append(&quot;\n&quot;);
    for (BizInfo bizInfo : bizInfoSet) {
        sb.append(
            String.format(&quot;bizName=%s, bizVersion=%s, bizState=%s&quot;, bizInfo.getBizName(),
                bizInfo.getBizVersion(), bizInfo.getBizState())).append(&quot;\n&quot;);
    }
    response.setCode(ResponseCode.SUCCESS).setBizInfos(bizInfoSet).setMessage(sb.toString());
    LOGGER.info(String.format(&quot;Check Biz: %s&quot;, response.getMessage()));
    return response;
}
</code></pre>

<p>激活 Ark Biz 时，需要先查找当前是否有同名 Biz 处于激活状态，如果有需要将状态切换为 deactivated，再将本次要激活的 Ark Biz 状态设置为 activated。</p>

<pre><code class="language-java">public void activeBiz(String bizName, String bizVersion) {
    ...
    Biz biz = getBiz(bizName, bizVersion);
    Biz activeBiz = getActiveBiz(bizName);
    if (biz != null &amp;&amp; biz.getBizState() == BizState.DEACTIVATED) {
        if (activeBiz != null) {
            ((BizModel) activeBiz).setBizState(BizState.DEACTIVATED);
        }
        ((BizModel) biz).setBizState(BizState.ACTIVATED);
    }
}
</code></pre>

<h2 id="总结">总结</h2>

<p>SOFAArk 通过轻量级的类隔离+动态装载的能力实现了动态合并部署，使开着飞机换引擎成为可能，能够极大的提升开发效率及应用可扩展性。</p>

</article>

<script>
  const article = document.querySelector('article.typo')
  
  const imgElements = article.querySelectorAll('img');
  
  imgElements.forEach(img => {
    const src = img.getAttribute('src');
    
    if (src.toLowerCase().endsWith('.image')) {
      img.setAttribute('src', src.replace('.image', ''));
    }
    img.setAttribute('referrerpolicy', 'no-referrer');
  });
</script>


	</main>
</div>



	


<footer class="ss-footer">
	<div class="container">
		<div class="links">
			
				<div class="cate">
					<h2 class="cate-title">资源</h2>
					
						<a class="link" href="https://github.com/sofastack">Github</a>
					
						<a class="link" href="https://gitee.com/sofastack/">Gitee</a>
					
						<a class="link" href="https://github.com/sofastack-guides">示例</a>
					
				</div>
			
				<div class="cate">
					<h2 class="cate-title">社交媒体</h2>
					
						<a class="link" href="https://zhuanlan.zhihu.com/sofastack">知乎专栏</a>
					
						<a class="link" href="https://weibo.com/sofastack">新浪微博</a>
					
						<a class="link" href="https://twitter.com/sofastack_io">Twitter</a>
					
				</div>
			
				<div class="cate">
					<h2 class="cate-title">参与进来</h2>
					
						<a class="link" href="https://github.com/sofastack/sofastack.tech/issues/new">反馈</a>
					
						<a class="link" href="https://github.com/sofastack/community">社区</a>
					
						<a class="link" href="https://github.com/sofastack/sofastack.tech/wiki">Wiki</a>
					
						<a class="link" href="mailto:sofa@alipay.cloud.com">Email</a>
					
						<a class="link" href="/hr/">加入我们</a>
					
				</div>
			
				<div class="cate">
					<h2 class="cate-title">蚂蚁集团开源项目</h2>
					
						<a class="link" href="https://ant.design/">Ant Design</a>
					
						<a class="link" href="https://eggjs.org/">Egg </a>
					
						<a class="link" href="https://sqlflow.org">SQLFlow</a>
					
						<a class="link" href="https://tech.antfin.com/open-source">更多</a>
					
				</div>
			
		</div>
		<div class="qrcode">
			
				<div>
					<img class="qrcode-img" src="/sofastack.tech/img/qrcode/qrcode_video.png" />
					<p class="qrcode-desc">微信视频号</p>
				</div>
			
				<div>
					<img class="qrcode-img" src="/sofastack.tech/img/qrcode/qrcode_1.png" />
					<p class="qrcode-desc">微信公众号</p>
				</div>
			
				<div>
					<img class="qrcode-img" src="/sofastack.tech/img/qrcode/dingtalk_7.jpg" />
					<p class="qrcode-desc">钉钉群</p>
				</div>
			
		</div>
	</div>
	<div class="copyright">
		<p>
			© 2018 - 2022  The SOFAStack Authors
			<a href="http://beian.miit.gov.cn/">浙 ICP 备 16045294 号-3</a>
		</p>
	</div>
</footer>

</body>

</html>